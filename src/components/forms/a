import React, { useState } from 'react';
import { CButton, CIcon, CFormInput, CInputGroup, CFormSelect, CTable, CTableBody, CTableDataCell, CTableRow } from '@coreui/react';
import Select from 'react-select';
import UploadFileModal from './UploadFileModal';  // Import the modal component

const ParentComponent = () => {
  const [form, setForm] = useState({
    chapters: [
      { chapter_number: '', chapter_name: '', chapter_source_pdf: '', chapter_source_epub: '', chapter_source_text: '', chapter_source_mp3: '', chapter_mp3_voice: '' }
    ]
  });
  const [materialOptions, setMaterialOptions] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [currentChapterIndex, setCurrentChapterIndex] = useState(null);

  const handleChapterMaterialSourceChange = (index, sourceType, selectedOption) => {
    const updatedChapters = [...form.chapters];
    updatedChapters[index][`chapter_source_${sourceType}`] = selectedOption.value;
    setForm({ ...form, chapters: updatedChapters });
  };

  const handleAddFileClick = (index) => {
    setCurrentChapterIndex(index);
    setShowModal(true);
  };

  const handleFileUpload = (newFile) => {
    // Add the new file to the materialOptions array and update the form state
    const newOption = { value: newFile.id, label: newFile.name };  // Example response data
    setMaterialOptions((prevOptions) => [...prevOptions, newOption]);

    // Automatically set the newly uploaded file in the relevant chapter
    const updatedChapters = [...form.chapters];
    updatedChapters[currentChapterIndex].chapter_source_pdf = newFile.id;  // Example for 'pdf', modify as needed
    setForm({ ...form, chapters: updatedChapters });
  };

  return (
    <>
      <CTable bordered className='my-3'>
        <CTableBody>
          {form.chapters.map((chapter, index) => (
            <React.Fragment key={index}>
              {/* Chapter rows */}
              <CTableRow>
                <CTableDataCell>
                  <CInputGroup>
                    <Select
                      name="pdf"
                      options={materialOptions}
                      value={materialOptions.find(option => option.value === chapter.chapter_source_pdf) || null}
                      onChange={(selectedOption) => handleChapterMaterialSourceChange(index, 'pdf', selectedOption)}
                      className="custom-select col-10"
                    />
                    <CButton type="button" size='sm' color="primary" className="col-2" onClick={() => handleAddFileClick(index)}>
                      <CIcon icon={cilFile} /> Add File
                    </CButton>
                  </CInputGroup>
                </CTableDataCell>
              </CTableRow>
            </React.Fragment>
          ))}
        </CTableBody>
      </CTable>

      {/* Add Chapter Button */}
      <CButton color="primary">+ Add Chapter</CButton>

      {/* File Upload Modal */}
      <UploadFileModal
        visible={showModal}
        onClose={() => setShowModal(false)}
        onFileUpload={handleFileUpload}
      />
    </>
  );
};

export default ParentComponent;
